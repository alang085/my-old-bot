# æ•°æ®åº“è¿ç§»æŒ‡å—

## ğŸ“Š å°†æœ¬åœ°æ•°æ®è¿ç§»åˆ° Zeabur éƒ¨ç½²ç¯å¢ƒ

### æ–¹æ³•ä¸€ï¼šå¯¼å‡º SQL å¹¶å¯¼å…¥ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šå¯¼å‡ºæœ¬åœ°æ•°æ®åº“ä¸º SQL

åœ¨æœ¬åœ°è¿è¡Œï¼š

```bash
# Windows PowerShell
cd C:\Users\zhuanqian\Desktop\loan005.bot

# ä½¿ç”¨ sqlite3 å¯¼å‡º
sqlite3 loan_bot.db .dump > database_backup.sql
```

å¦‚æœæ²¡æœ‰ sqlite3 å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨ Python è„šæœ¬ï¼š

```python
# export_db.py
import sqlite3
import sys

def export_database(db_path, output_file):
    conn = sqlite3.connect(db_path)
    with open(output_file, 'w', encoding='utf-8') as f:
        for line in conn.iterdump():
            f.write(f'{line}\n')
    conn.close()
    print(f"æ•°æ®åº“å·²å¯¼å‡ºåˆ°: {output_file}")

if __name__ == '__main__':
    export_database('loan_bot.db', 'database_backup.sql')
```

è¿è¡Œï¼š
```bash
python export_db.py
```

#### æ­¥éª¤ 2ï¼šåœ¨ Zeabur ç¯å¢ƒå¯¼å…¥æ•°æ®

**é€‰é¡¹ Aï¼šé€šè¿‡ SSH/ç»ˆç«¯è®¿é—®å®¹å™¨ï¼ˆå¦‚æœæ”¯æŒï¼‰**

```bash
# 1. å°† database_backup.sql ä¸Šä¼ åˆ°å®¹å™¨
# 2. åœ¨å®¹å™¨ä¸­æ‰§è¡Œ
sqlite3 /data/loan_bot.db < database_backup.sql
# æˆ–
sqlite3 /app/loan_bot.db < database_backup.sql
```

**é€‰é¡¹ Bï¼šé€šè¿‡ä»£ç å¯¼å…¥ï¼ˆæ¨èï¼‰**

åˆ›å»ºä¸€ä¸ªè¿ç§»è„šæœ¬ `migrate_data.py`ï¼š

```python
"""æ•°æ®åº“è¿ç§»è„šæœ¬"""
import sqlite3
import os
import sys

def import_sql_file(db_path, sql_file):
    """ä» SQL æ–‡ä»¶å¯¼å…¥æ•°æ®"""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    with open(sql_file, 'r', encoding='utf-8') as f:
        sql_script = f.read()
    
    # æ‰§è¡Œ SQL è„šæœ¬
    cursor.executescript(sql_script)
    conn.commit()
    conn.close()
    print(f"æ•°æ®å·²å¯¼å…¥åˆ°: {db_path}")

if __name__ == '__main__':
    # ä»ç¯å¢ƒå˜é‡è·å–æ•°æ®åº“è·¯å¾„
    data_dir = os.getenv('DATA_DIR', os.path.dirname(os.path.abspath(__file__)))
    db_path = os.path.join(data_dir, 'loan_bot.db')
    sql_file = 'database_backup.sql'
    
    if not os.path.exists(sql_file):
        print(f"é”™è¯¯: æ‰¾ä¸åˆ° {sql_file}")
        sys.exit(1)
    
    import_sql_file(db_path, sql_file)
```

### æ–¹æ³•äºŒï¼šç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨ Volumeï¼‰

å¦‚æœ Zeabur æ”¯æŒæ–‡ä»¶ä¸Šä¼ æˆ– Volume æŒ‚è½½ï¼š

1. **å°†æœ¬åœ°æ•°æ®åº“æ–‡ä»¶ä¸Šä¼ åˆ° Volume**
   - é€šè¿‡ Zeabur çš„æ–‡ä»¶ç®¡ç†åŠŸèƒ½
   - æˆ–é€šè¿‡ SFTP/SCP ä¸Šä¼ åˆ° `/data/loan_bot.db`

2. **ç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®**
   ```bash
   chmod 644 /data/loan_bot.db
   ```

### æ–¹æ³•ä¸‰ï¼šé€šè¿‡åº”ç”¨åŠŸèƒ½é‡æ–°åˆ›å»ºæ•°æ®ï¼ˆæœ€ç®€å•ï¼‰

å¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œå¯ä»¥ï¼š

1. **åœ¨éƒ¨ç½²ç¯å¢ƒä¸­æ‰‹åŠ¨é‡æ–°åˆ›å»ºæ•°æ®**
   - é€šè¿‡ Telegram æœºå™¨äººå‘½ä»¤
   - é‡æ–°åˆ›å»ºè®¢å•ã€é…ç½®ç­‰

2. **ä½¿ç”¨æœºå™¨äººå‘½ä»¤å¯¼å…¥å…³é”®æ•°æ®**
   - åˆ›å»ºå½’å±IDï¼š`/create_attribution`
   - æ·»åŠ å‘˜å·¥ï¼š`/add_employee`
   - åˆ›å»ºè®¢å•ï¼š`/create`ï¼ˆåœ¨ç¾¤ç»„ä¸­ï¼‰

### æ–¹æ³•å››ï¼šä½¿ç”¨ Python è„šæœ¬è¿ç§»ï¼ˆè‡ªåŠ¨åŒ–ï¼‰

åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„è¿ç§»è„šæœ¬ï¼š

```python
# migrate_to_zeabur.py
import sqlite3
import os
import json

def export_to_json(db_path, output_file):
    """å¯¼å‡ºæ•°æ®åº“ä¸º JSON æ ¼å¼"""
    conn = sqlite3.connect(db_path)
    conn.row_factory = sqlite3.Row
    
    data = {
        'orders': [],
        'financial_data': {},
        'grouped_data': [],
        'daily_data': [],
        'payment_accounts': [],
        'employees': [],
        'attributions': []
    }
    
    # å¯¼å‡ºè®¢å•
    cursor = conn.execute('SELECT * FROM orders')
    for row in cursor:
        data['orders'].append(dict(row))
    
    # å¯¼å‡ºè´¢åŠ¡æ•°æ®
    cursor = conn.execute('SELECT * FROM financial_data ORDER BY id DESC LIMIT 1')
    row = cursor.fetchone()
    if row:
        data['financial_data'] = dict(row)
    
    # å¯¼å‡ºåˆ†ç»„æ•°æ®
    cursor = conn.execute('SELECT * FROM grouped_data')
    for row in cursor:
        data['grouped_data'].append(dict(row))
    
    # å¯¼å‡ºæ—¥ç»“æ•°æ®
    cursor = conn.execute('SELECT * FROM daily_data')
    for row in cursor:
        data['daily_data'].append(dict(row))
    
    # å¯¼å‡ºæ”¯ä»˜è´¦æˆ·
    cursor = conn.execute('SELECT * FROM payment_accounts')
    for row in cursor:
        data['payment_accounts'].append(dict(row))
    
    # å¯¼å‡ºå‘˜å·¥
    cursor = conn.execute('SELECT * FROM employees')
    for row in cursor:
        data['employees'].append(dict(row))
    
    # å¯¼å‡ºå½’å±ID
    cursor = conn.execute('SELECT * FROM attributions')
    for row in cursor:
        data['attributions'].append(dict(row))
    
    conn.close()
    
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    
    print(f"æ•°æ®å·²å¯¼å‡ºåˆ°: {output_file}")

if __name__ == '__main__':
    export_to_json('loan_bot.db', 'database_backup.json')
```

ç„¶ååœ¨éƒ¨ç½²ç¯å¢ƒä¸­åˆ›å»ºå¯¹åº”çš„å¯¼å…¥è„šæœ¬ã€‚

## ğŸš€ æ¨èæµç¨‹

### å¿«é€Ÿè¿ç§»ï¼ˆé€‚åˆå°æ•°æ®é‡ï¼‰

1. **å¯¼å‡ºæœ¬åœ°æ•°æ®åº“**
   ```bash
   python export_db.py
   ```

2. **å°† `database_backup.sql` æ·»åŠ åˆ°é¡¹ç›®**
   - ä¸´æ—¶æ·»åŠ åˆ° Gitï¼ˆä»…ç”¨äºè¿ç§»ï¼‰
   - æˆ–é€šè¿‡å…¶ä»–æ–¹å¼ä¸Šä¼ åˆ°éƒ¨ç½²ç¯å¢ƒ

3. **åœ¨éƒ¨ç½²ç¯å¢ƒä¸­è¿è¡Œå¯¼å…¥è„šæœ¬**
   - åˆ›å»º `migrate_data.py`
   - åœ¨ Zeabur å®¹å™¨ä¸­æ‰§è¡Œ

### å®‰å…¨è¿ç§»ï¼ˆæ¨èï¼‰

1. **ä¸æäº¤æ•æ„Ÿæ•°æ®åˆ° Git**
   - æ•°æ®åº“æ–‡ä»¶å’Œ SQL å¤‡ä»½ä¸æäº¤
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ– Volume

2. **é€šè¿‡åº”ç”¨åŠŸèƒ½é‡æ–°åˆ›å»º**
   - æ‰‹åŠ¨é‡æ–°è¾“å…¥å…³é”®æ•°æ®
   - ä½¿ç”¨æœºå™¨äººå‘½ä»¤åˆ›å»º

3. **é…ç½®æŒä¹…åŒ–å­˜å‚¨**
   - åœ¨ Zeabur é…ç½® Volume
   - è®¾ç½® `DATA_DIR=/data` ç¯å¢ƒå˜é‡

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“æ–‡ä»¶ä¸åº”æäº¤åˆ° Git**
   - `.gitignore` å·²æ’é™¤ `*.db` æ–‡ä»¶
   - æ¯ä¸ªç¯å¢ƒæœ‰ç‹¬ç«‹çš„æ•°æ®åº“

2. **å¤‡ä»½é‡è¦æ•°æ®**
   - è¿ç§»å‰å…ˆå¤‡ä»½æœ¬åœ°æ•°æ®åº“
   - ä¿ç•™ SQL å¯¼å‡ºæ–‡ä»¶

3. **æµ‹è¯•è¿ç§»**
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   - ç¡®è®¤æ•°æ®å®Œæ•´æ€§

4. **ç¯å¢ƒå˜é‡é…ç½®**
   - ç¡®ä¿ Zeabur ç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½®
   - `BOT_TOKEN` å’Œ `ADMIN_USER_IDS` å¿…é¡»é…ç½®

## ğŸ“ å¿«é€Ÿå‘½ä»¤

```bash
# 1. å¯¼å‡ºæ•°æ®åº“
sqlite3 loan_bot.db .dump > database_backup.sql

# 2. æŸ¥çœ‹æ•°æ®åº“è¡¨
sqlite3 loan_bot.db ".tables"

# 3. æŸ¥çœ‹æ•°æ®é‡
sqlite3 loan_bot.db "SELECT COUNT(*) FROM orders;"
sqlite3 loan_bot.db "SELECT COUNT(*) FROM financial_data;"
```

