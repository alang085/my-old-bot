# 本地测试运行指南

## 📋 运行前检查清单

### ✅ 1. 检查 Python 版本
```bash
python --version
# 需要 Python 3.8 或更高版本
```

### ✅ 2. 检查配置文件
- [ ] `user_config.py` 已创建并配置（或设置环境变量）
- [ ] `BOT_TOKEN` 已设置
- [ ] `ADMIN_USER_IDS` 已设置

### ✅ 3. 安装依赖
```bash
pip install -r requirements.txt
```

### ✅ 4. 初始化数据库
```bash
python init_db.py
```

---

## 🚀 快速启动步骤

### 方式一：使用配置文件（推荐）

#### 步骤 1：创建配置文件
```bash
# 复制示例配置文件
copy user_config.example.py user_config.py  # Windows
# 或
cp user_config.example.py user_config.py    # Linux/Mac
```

#### 步骤 2：编辑 `user_config.py`
```python
BOT_TOKEN = '你的机器人Token'
ADMIN_USER_IDS = '你的用户ID'  # 多个ID用逗号分隔，如：'123456789,987654321'
```

#### 步骤 3：初始化数据库
```bash
python init_db.py
```

#### 步骤 4：运行项目
```bash
python main.py
```

---

### 方式二：使用环境变量

#### Windows PowerShell
```powershell
# 设置环境变量
$env:BOT_TOKEN="你的机器人Token"
$env:ADMIN_USER_IDS="你的用户ID"

# 初始化数据库
python init_db.py

# 运行项目
python main.py
```

#### Linux/Mac
```bash
# 设置环境变量
export BOT_TOKEN="你的机器人Token"
export ADMIN_USER_IDS="你的用户ID"

# 初始化数据库
python init_db.py

# 运行项目
python main.py
```

---

## 🔍 配置获取方法

### 获取 BOT_TOKEN
1. 在 Telegram 中搜索 **@BotFather**
2. 发送 `/newbot` 创建新机器人（或使用已有机器人）
3. 发送 `/token` 获取 Token
4. 复制 Token 到配置文件

### 获取用户 ID
1. 在 Telegram 中搜索 **@userinfobot**
2. 发送任意消息给机器人
3. 机器人会回复你的用户 ID（纯数字）
4. 复制用户 ID 到配置文件

---

## ✅ 运行验证

### 启动成功的标志
看到以下输出说明启动成功：
```
机器人启动中...
管理员数量: 1
检查数据库...
数据库已就绪
机器人已启动，等待消息...
命令菜单已更新
定时播报任务已初始化
```

### 测试功能

#### 1. 私聊测试（发送给机器人）
```
/start
```
应该收到帮助信息

#### 2. 查看报表
```
/report
```
应该显示报表界面

#### 3. 收入明细（仅管理员）
- 在报表界面点击"💰 收入明细"按钮

---

## 🐛 常见问题

### 问题 1：配置错误
**错误信息：**
```
BOT_TOKEN 未设置！
```

**解决方法：**
- 检查 `user_config.py` 文件是否存在
- 检查环境变量是否正确设置
- 参考 `user_config.example.py` 格式

### 问题 2：数据库错误
**错误信息：**
```
数据库初始化失败
```

**解决方法：**
- 确保有写入权限
- 检查 `loan_bot.db` 文件是否被锁定
- 尝试删除数据库文件重新初始化

### 问题 3：模块导入错误
**错误信息：**
```
ModuleNotFoundError: No module named 'xxx'
```

**解决方法：**
```bash
pip install -r requirements.txt
```

### 问题 4：Token 无效
**错误信息：**
```
Token 无效或被拒绝
```

**解决方法：**
- 检查 Token 是否正确
- 确认 Token 未被撤销
- 在 @BotFather 中重新获取 Token

### 问题 5：权限错误
**错误信息：**
```
Permission denied
```

**解决方法：**
- 确认你的用户 ID 在 `ADMIN_USER_IDS` 中
- 检查用户 ID 格式（纯数字，多个用逗号分隔）

---

## 🔧 调试模式

### 启用调试输出
```bash
# Windows PowerShell
$env:DEBUG="1"
python main.py

# Linux/Mac
DEBUG=1 python main.py
```

调试模式下会显示：
- 项目根目录
- Python 路径
- 模块加载状态

---

## 📊 数据库文件位置

### 默认位置
- **数据库文件**：`loan_bot.db`（项目根目录）

### 自定义位置
```bash
# Windows PowerShell
$env:DATA_DIR="D:\data"
python main.py

# Linux/Mac
export DATA_DIR="/path/to/data"
python main.py
```

---

## 🛑 停止运行

### 正常停止
按 `Ctrl+C` 停止机器人

### 强制停止（如果卡死）
1. 关闭终端窗口
2. 或在任务管理器中结束 Python 进程

---

## 📝 日志查看

### 控制台日志
所有日志会输出到控制台，包括：
- 错误信息
- 操作日志
- 数据库操作日志

### 日志级别
- **INFO**：正常运行信息
- **WARNING**：警告信息
- **ERROR**：错误信息

---

## 🎯 快速测试命令

### 基础测试
```bash
# 1. 检查配置
python -c "from config import BOT_TOKEN, ADMIN_IDS; print(f'Token: {BOT_TOKEN[:10]}..., Admins: {len(ADMIN_IDS)}')"

# 2. 检查数据库
python -c "import init_db; init_db.init_database(); print('Database OK')"

# 3. 检查依赖
python -c "import telegram; print('Dependencies OK')"
```

---

## ✅ 运行检查清单

- [ ] Python 版本 >= 3.8
- [ ] 依赖已安装（`pip install -r requirements.txt`）
- [ ] `user_config.py` 已配置（或环境变量已设置）
- [ ] `BOT_TOKEN` 已设置
- [ ] `ADMIN_USER_IDS` 已设置
- [ ] 数据库已初始化（`python init_db.py`）
- [ ] 可以正常启动（`python main.py`）
- [ ] 机器人响应 `/start` 命令

---

## 🎉 成功启动后

1. **测试私聊命令**
   - `/start` - 查看帮助
   - `/report` - 查看报表

2. **测试收入明细功能**
   - 在报表界面点击"💰 收入明细"
   - 查看今日收入明细

3. **测试群组功能**
   - 在群组中创建订单
   - 测试订单状态变更

---

**祝测试顺利！** 🚀

