# 代码结构文档

## 📁 项目目录结构

```
loan005.bot/
├── main.py                 # 主入口文件
├── config.py               # 配置管理
├── constants.py            # 常量定义
├── decorators.py           # 装饰器（权限、错误处理）
├── init_db.py              # 数据库初始化
├── db_operations.py        # 数据库操作层
│
├── handlers/               # 命令和消息处理器
│   ├── __init__.py        # 统一导出所有处理器
│   ├── command_handlers.py     # 基础命令处理器
│   ├── order_handlers.py       # 订单状态处理器
│   ├── amount_handlers.py      # 金额操作处理器
│   ├── report_handlers.py      # 报表处理器
│   ├── income_handlers.py      # 收入明细处理器（新增）
│   ├── search_handlers.py      # 搜索处理器
│   ├── message_handlers.py     # 消息输入处理器
│   ├── broadcast_handlers.py   # 播报处理器
│   ├── payment_handlers.py     # 支付账户处理器
│   ├── schedule_handlers.py    # 定时播报处理器
│   └── attribution_handlers.py # 归属ID处理器
│
├── callbacks/              # 回调处理器
│   ├── __init__.py        # 统一导出所有回调
│   ├── main_callback.py        # 主回调路由
│   ├── report_callbacks.py     # 报表回调
│   ├── search_callbacks.py     # 搜索回调
│   ├── order_callbacks.py      # 订单回调
│   ├── payment_callbacks.py    # 支付账户回调
│   └── schedule_callbacks.py   # 定时播报回调
│
├── utils/                  # 工具函数
│   ├── __init__.py        # 统一导出工具函数
│   ├── date_helpers.py         # 日期工具
│   ├── chat_helpers.py         # 聊天工具
│   ├── order_helpers.py        # 订单工具
│   ├── stats_helpers.py        # 统计工具
│   ├── message_helpers.py      # 消息工具
│   ├── broadcast_helpers.py    # 播报工具
│   ├── amount_helpers.py       # 金额工具
│   ├── message_builders.py     # 消息构建器
│   ├── db_helpers.py           # 数据库工具
│   └── schedule_executor.py    # 定时任务执行器
│
└── [其他文件]
    ├── 数据库相关：*.db, database_backup.sql
    ├── 配置文件：user_config.py, requirements.txt
    └── 文档：*.md
```

---

## 📦 模块说明

### 1. 核心模块

#### `main.py` - 主入口
- **职责**：应用初始化、路由注册、启动机器人
- **关键功能**：
  - 数据库初始化
  - 命令处理器注册
  - 回调处理器注册
  - 消息处理器注册
  - 定时任务设置

#### `config.py` - 配置管理
- **职责**：加载和管理配置
- **配置项**：
  - `BOT_TOKEN` - 机器人令牌
  - `ADMIN_IDS` - 管理员ID列表

#### `constants.py` - 常量定义
- **职责**：定义全局常量
- **常量类型**：
  - 星期分组映射
  - 订单状态
  - 收入类型
  - 客户类型
  - 用户状态

#### `decorators.py` - 装饰器
- **职责**：权限控制和错误处理
- **装饰器**：
  - `@error_handler` - 错误处理
  - `@admin_required` - 管理员权限
  - `@authorized_required` - 授权用户权限
  - `@private_chat_only` - 仅私聊
  - `@group_chat_only` - 仅群组

#### `db_operations.py` - 数据库操作层
- **职责**：所有数据库操作的统一接口
- **功能模块**：
  - 订单操作
  - 财务数据操作
  - 分组数据操作
  - 日结数据操作
  - 授权用户操作
  - 支付账号操作
  - 开销记录操作
  - **收入明细操作（新增）**
  - 定时播报操作

---

### 2. Handlers 模块（命令处理器）

#### `command_handlers.py` - 基础命令
- `/start` - 启动/帮助
- `/create` - 创建订单
- `/adjust` - 调整资金
- `/create_attribution` - 创建归属ID
- 员工管理命令
- 统计修复命令

#### `order_handlers.py` - 订单状态
- `/normal` - 设为正常
- `/overdue` - 设为逾期
- `/end` - 设为完成
- `/breach` - 设为违约
- `/breach_end` - 违约完成

#### `amount_handlers.py` - 金额操作
- `+金额` - 利息收入
- `+金额b` - 本金减少
- **自动记录收入明细**

#### `report_handlers.py` - 报表
- `/report` - 显示报表
- `/myreport` - 显示我的报表
- 报表文本生成

#### `income_handlers.py` - 收入明细（新增）
- **仅管理员权限**
- 今日收入明细
- 本月收入明细
- 日期范围查询
- 分类查询
- 多维度汇总展示

#### `search_handlers.py` - 搜索
- `/search` - 查找订单
- 支持多条件组合查询

#### `message_handlers.py` - 消息输入
- 处理各种文本输入状态
- 开销查询输入
- 报表查询输入
- 搜索输入
- **收入明细查询输入（新增）**

---

### 3. Callbacks 模块（回调处理器）

#### `main_callback.py` - 主路由
- 路由所有回调到对应的处理器
- 权限检查
- 错误处理

#### `report_callbacks.py` - 报表回调
- 报表视图切换
- 开销记录管理
- 归属查询
- 订单查找
- **收入明细查询（新增）**

#### `search_callbacks.py` - 搜索回调
- 搜索条件选择
- 搜索结果展示
- 归属变更

---

### 4. Utils 模块（工具函数）

#### `date_helpers.py` - 日期工具
- `get_daily_period_date()` - 获取日结日期

#### `order_helpers.py` - 订单工具
- 解析群名生成订单
- 自动更新订单状态
- 订单创建逻辑

#### `stats_helpers.py` - 统计工具
- `update_all_stats()` - 更新所有统计
- `update_liquid_capital()` - 更新流动资金

#### `broadcast_helpers.py` - 播报工具
- 计算下个付款日期
- 格式化播报消息

---

## 🔄 数据流

### 收入记录流程

```
业务操作（订单完成、利息等）
    ↓
业务处理器（order_handlers.py, amount_handlers.py）
    ↓
自动调用 record_income()
    ↓
db_operations.py
    ↓
写入 income_records 表
```

### 收入查询流程

```
用户点击"收入明细"按钮
    ↓
report_callbacks.py 处理回调
    ↓
income_handlers.py 生成报表
    ↓
db_operations.py 查询数据
    ↓
格式化并展示给用户
```

---

## 📊 数据库表结构

### 核心表

1. **orders** - 订单表
   - 存储所有订单信息
   - 支持状态变更
   - 关联归属ID和客户类型

2. **financial_data** - 全局财务数据
   - 累计统计数据
   - 单条记录存储

3. **grouped_data** - 分组数据
   - 按归属ID分组的统计
   - 每个归属ID一条记录

4. **daily_data** - 日结数据
   - 按日期和归属ID存储流量数据
   - 支持日期范围查询

5. **income_records** - 收入明细表（新增）
   - 记录每笔收入的详细信息
   - 支持多维度查询和汇总
   - 按类型、客户、归属ID分类

6. **expense_records** - 支出明细表
   - 记录每笔支出的详细信息

---

## 🔐 权限体系

### 权限级别

1. **管理员（ADMIN_IDS）**
   - 所有功能
   - 收入明细查询
   - 系统配置

2. **授权员工（authorized_users）**
   - 基础操作
   - 订单管理
   - 报表查看
   - 开销记录

3. **受限用户（user_group_mapping）**
   - 仅能查看指定归属ID的报表
   - 不能查看全局数据

---

## 🎯 关键功能模块

### 收入明细系统（新增）

**功能特性**：
- ✅ 自动记录所有收入来源
- ✅ 多维度分类展示
- ✅ 支持日期范围查询
- ✅ 按类型、客户、归属ID汇总
- ✅ 仅管理员权限

**收入类型**：
1. 订单完成（completed）
2. 违约完成（breach_end）
3. 利息收入（interest）
4. 本金减少（principal_reduction）
5. 资金调整（adjustment）

---

## 📝 代码规范

### 导入顺序
1. 标准库
2. 第三方库
3. 本地模块
4. 相对导入

### 函数命名
- 处理器函数：`handle_xxx()`
- 回调函数：`handle_xxx_callback()`
- 工具函数：`get_xxx()`, `format_xxx()`, `update_xxx()`

### 注释规范
- 模块级：说明模块职责
- 函数级：说明功能、参数、返回值
- 复杂逻辑：关键步骤注释

---

## 🔧 优化建议

### 已完成的优化
1. ✅ 统一模块导出（`__init__.py`）
2. ✅ 清晰的模块划分
3. ✅ 统一的错误处理
4. ✅ 权限装饰器统一管理
5. ✅ 收入明细系统完整实现

### 未来优化方向
1. 代码复用进一步优化
2. 单元测试补充
3. 性能优化（数据库查询）
4. 日志系统完善

---

## 📚 相关文档

- `报表数据变更逻辑说明.md` - 数据更新规则
- `创建订单逻辑说明.md` - 订单创建流程
- `权限说明文档.md` - 权限体系详解
- `群名解析定义说明.md` - 群名解析规则

---

**最后更新时间**：2024-11-27

